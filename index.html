<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imagist.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
    <style>
        :root {
            --background-primary: #ffffff; --background-secondary: #f5f5f7; --background-tertiary: #e9e9eb;
            --text-primary: #1d1d1f; --text-secondary: #515154; --accent-color: #FF0436;
            --accent-color_alpha_30: rgba(255, 4, 54, 0.3); --border-color: #d2d2d7;
            --shadow-color-light: rgba(0, 0, 0, 0.08); --shadow-color-medium: rgba(0, 0, 0, 0.12);
            --icon-fill-theme-toggle: #515154; 
            --button-hover-bg: #e0e0e2;
            --btn-active-bg: #cdd0d3; /* For active preset button */
        }
        html.dark {
            --background-primary: #1c1c1e; --background-secondary: #2c2c2e; --background-tertiary: #3a3a3c;
            --text-primary: #f5f5f7; --text-secondary: #a1a1a6; --accent-color: #FF0436;
            --accent-color_alpha_30: rgba(255, 4, 54, 0.3); --border-color: #4a4a4e;
            --shadow-color-light: rgba(0, 0, 0, 0.25); --shadow-color-medium: rgba(0, 0, 0, 0.35);
            --icon-fill-theme-toggle: #a1a1a6; 
            --button-hover-bg: #4f4f52;
            --btn-active-bg: #5a5d60; /* For active preset button in dark mode */
        }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--background-primary); color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            padding-bottom: 2rem; 
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--background-secondary); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        .btn {
            padding: 0.6rem 1.2rem; border-radius: 0.5rem; font-weight: 500; cursor: pointer;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            border: 1px solid var(--border-color); background-color: var(--background-tertiary); color: var(--text-primary);
        }
        .btn:hover { background-color: var(--button-hover-bg); box-shadow: 0 2px 4px var(--shadow-color-light); }
        .btn-primary { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        .btn-primary:hover { opacity: 0.9; background-color: var(--accent-color); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; background-color: var(--background-tertiary); color: var(--text-secondary); border-color: var(--border-color); }
        .btn:disabled:hover { box-shadow: none; }
        
        .btn-preset { /* Specific styling for preset buttons */
            padding: 0.4rem 0.8rem; /* Slightly smaller padding */
            font-size: 0.8rem;
        }
        .btn-preset.active {
            background-color: var(--btn-active-bg);
            border-color: var(--accent-color);
            color: var(--accent-color);
            font-weight: 600;
        }


        .input-field {
            background-color: var(--background-primary); border: 1px solid var(--border-color); color: var(--text-primary);
            border-radius: 0.5rem; padding: 0.5rem 0.75rem; transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input-field:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--accent-color_alpha_30); }
        
        .tool-section { 
            background-color: var(--background-secondary); 
            padding: 1.5rem; 
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px var(--shadow-color-light); 
            margin-bottom: 1.5rem; 
        }
        .tool-section h3 { 
            font-size: 1.1rem; 
            font-weight: 600; 
            color: var(--text-primary);
            margin-bottom: 1rem; 
            padding-bottom: 0.5rem; 
            border-bottom: 1px solid var(--border-color);
        }

        #image-preview-container {
            border: 2px dashed var(--border-color); background-color: var(--background-secondary);
            transition: border-color 0.3s ease; position: relative;
        }
        #image-preview-container.dragover { border-color: var(--accent-color); }
        #image-canvas { max-width: 100%; max-height: 500px; object-fit: contain; border-radius: 0.5rem; display: block; }
        
        #image-info-display {
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--background-secondary);
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px var(--shadow-color-light);
            font-size: 0.875rem; 
            color: var(--text-secondary);
        }
        #image-info-display p { margin-bottom: 0.5rem; }
        #image-info-display .info-line-flex { margin-bottom: 0; } 
        #image-info-display strong { color: var(--text-primary); font-weight: 500; }

        .credit-line {
            font-size: 0.75rem; 
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem; 
        }
        .credit-line strong {
            color: var(--text-primary);
            font-weight: 600;
        }
        .credit-line a svg {
            width: 1.125rem; 
            height: 1.125rem; 
            fill: var(--accent-color); 
            transition: opacity 0.2s ease; 
        }
        .credit-line a:hover svg {
            opacity: 0.8; 
        }


        .cropper-container { font-family: 'Inter', sans-serif; }
        .cropper-view-box, .cropper-face { border-radius: 0.375rem; }
        html.dark .cropper-modal { background-color: rgba(28, 28, 30, 0.75); }
        
        #theme-toggle {
            background-color: var(--background-tertiary); color: var(--icon-fill-theme-toggle); border: 1px solid var(--border-color);
            border-radius: 9999px; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        }
        #theme-toggle:hover { background-color: var(--button-hover-bg); box-shadow: 0 1px 3px var(--shadow-color-light); }
        #theme-toggle svg { width: 20px; height: 20px; fill: currentColor; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        html.dark .modal-overlay { background-color: rgba(0, 0, 0, 0.7); }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--background-secondary); color: var(--text-primary); padding: 2rem;
            border-radius: 0.75rem; box-shadow: 0 10px 30px var(--shadow-color-medium);
            width: 90%; max-width: 400px; text-align: center;
        }
        .modal-content p { margin-bottom: 1.5rem; color: var(--text-secondary); }
        .filter-btn-group button, .transform-btn-group button, .crop-preset-group button { margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .filter-btn-group button:last-child, .transform-btn-group button:last-child, .crop-preset-group button:last-child { margin-right: 0; }
        input[type="range"] {
            -webkit-appearance: none; appearance: none; width: 100%; height: 8px;
            background: var(--border-color); border-radius: 5px; outline: none; opacity: 0.9; transition: opacity .2s;
        }
        input[type="range"]:hover { opacity: 1; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            background: var(--accent-color); border-radius: 50%; cursor: pointer; border: 2px solid var(--background-secondary); 
        }
        input[type="range"]::-moz-range-thumb {
            width: 18px; height: 18px; background: var(--accent-color);
            border-radius: 50%; cursor: pointer; border: 2px solid var(--background-secondary);
        }
        .main-heading { color: var(--accent-color); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-6 md:p-8">

    <div class="fixed top-4 right-4 z-50"> 
        <button id="theme-toggle" aria-label="Toggle light and dark mode">
            <svg id="sun-icon" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.166 7.758a.75.75 0 001.06-1.06L5.634 5.106a.75.75 0 00-1.06 1.06l1.59 1.591z"></path></svg>
            <svg id="moon-icon" class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="display:none;"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 004.472-.69a.75.75 0 01.82.162button2.37a.75.75 0 01-.942.659A10.437 10.437 0 0118 19.5a10.5 10.5 0 01-10.5-10.5 10.437 10.437 0 011.113-4.744.75.75 0 01.659-.942z" clip-rule="evenodd"></path></svg>
        </button>
    </div>

    <div class="w-full max-w-5xl mt-16">
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-3xl sm:text-4xl font-bold main-heading">Imagist.</h1>
            <p class="text-md sm:text-lg mt-2" style="color: var(--text-secondary);">Upload, edit, and download your images with ease.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-1 space-y-6">
                <div class="tool-section" id="upload-tool-section">
                    <h3>Upload Image</h3>
                    <label for="file-upload" class="btn btn-primary w-full text-center block">
                        Choose File
                    </label>
                    <input type="file" id="file-upload" accept="image/jpeg, image/png, image/webp" class="hidden">
                    <p class="text-xs mt-2 text-center" style="color: var(--text-secondary);">Or drag & drop an image into the preview area.</p>
                    <p class="text-xs mt-1 text-center" style="color: var(--text-secondary);">Supports JPG, PNG, WEBP.</p>
                </div>

                <div id="tools-container" class="space-y-6 hidden"> 
                    <div class="tool-section" id="crop-tool-section">
                        <h3>Crop</h3>
                        <div class="mb-3">
                            <label class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">Aspect Ratio:</label>
                            <div class="flex flex-wrap gap-2 crop-preset-group">
                                <button class="btn btn-preset active" data-ratio="NaN">Free</button>
                                <button class="btn btn-preset" data-ratio="1">1:1</button>
                                <button class="btn btn-preset" data-ratio="1.7777777777777777">16:9</button> <button class="btn btn-preset" data-ratio="1.3333333333333333">4:3</button> <button class="btn btn-preset" data-ratio="0.6666666666666666">2:3</button> </div>
                        </div>
                        <button id="crop-btn" class="btn w-full">Start Crop</button>
                        <div id="crop-actions" class="hidden mt-3 space-x-2 flex justify-between">
                            <button id="confirm-crop-btn" class="btn btn-primary flex-grow">Confirm</button>
                            <button id="cancel-crop-btn" class="btn flex-grow">Cancel</button>
                        </div>
                        <p id="crop-instructions" class="text-xs mt-2 text-center" style="color: var(--text-secondary); display:none;">Adjust selection on the image.</p>
                    </div>
                    
                    <div class="tool-section" id="transform-tool-section">
                        <h3>Transform</h3>
                        <div class="grid grid-cols-2 gap-2 transform-btn-group">
                            <button id="rotate-left-btn" class="btn">Rotate Left 90°</button>
                            <button id="rotate-right-btn" class="btn">Rotate Right 90°</button>
                            <button id="flip-horizontal-btn" class="btn">Flip Horizontal</button>
                            <button id="flip-vertical-btn" class="btn">Flip Vertical</button>
                        </div>
                    </div>

                    <div class="tool-section" id="filters-tool-section">
                        <h3>Filters</h3>
                        <div class="grid grid-cols-2 gap-2 filter-btn-group">
                            <button id="filter-grayscale" class="btn">Grayscale</button>
                            <button id="filter-sepia" class="btn">Sepia</button>
                            <button id="filter-invert" class="btn">Invert</button>
                            <button id="filter-none" class="btn">Original</button>
                        </div>
                        <div class="mt-4">
                            <label for="brightness-slider" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">Brightness: <span id="brightness-value">100</span>%</label>
                            <input type="range" id="brightness-slider" min="0" max="200" value="100" class="w-full">
                        </div>
                        <div class="mt-3">
                            <label for="contrast-slider" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">Contrast: <span id="contrast-value">100</span>%</label>
                            <input type="range" id="contrast-slider" min="0" max="200" value="100" class="w-full">
                        </div>
                    </div>

                    <div class="tool-section" id="resize-tool-section">
                         <h3>Resize</h3>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label for="resize-width" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">Width (px)</label>
                                <input type="number" id="resize-width" class="input-field w-full" placeholder="e.g., 800">
                            </div>
                            <div>
                                <label for="resize-height" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">Height (px)</label>
                                <input type="number" id="resize-height" class="input-field w-full" placeholder="e.g., 600">
                            </div>
                        </div>
                        <div class="flex items-center mb-3">
                            <input type="checkbox" id="aspect-ratio-lock" class="mr-2 h-4 w-4 rounded" style="accent-color: var(--accent-color);" checked>
                            <label for="aspect-ratio-lock" class="text-sm" style="color: var(--text-secondary);">Lock aspect ratio</label>
                        </div>
                        <button id="resize-btn" class="btn w-full">Apply Resize</button>
                    </div>

                    <div class="tool-section" id="download-tool-section">
                        <h3>Download</h3>
                        <div class="mb-3">
                            <label for="file-format" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">Format</label>
                            <select id="file-format" class="input-field w-full">
                                <option value="image/png">PNG</option>
                                <option value="image/jpeg">JPEG</option>
                                <option value="image/webp">WEBP</option>
                            </select>
                        </div>
                        <div id="jpeg-quality-section" class="mb-3 hidden">
                             <label for="jpeg-quality" class="block text-sm font-medium mb-1" style="color: var(--text-secondary);">JPEG Quality: <span id="jpeg-quality-value">0.92</span></label>
                            <input type="range" id="jpeg-quality" min="0.1" max="1" step="0.01" value="0.92" class="w-full">
                        </div>
                        <button id="download-btn" class="btn btn-primary w-full">Download Image</button>
                    </div>
                </div>
            </div>

            <div class="md:col-span-2">
                <div id="image-preview-container" class="w-full h-64 md:h-[500px] flex items-center justify-center rounded-lg p-2">
                    <canvas id="image-canvas"></canvas>
                    <p id="image-placeholder" class="text-center" style="color: var(--text-secondary);">Image preview will appear here</p>
                </div>
                <div id="image-info-display" class="hidden">
                    <p><strong>File Name:</strong> <span id="info-file-name">-</span></p>
                    <p><strong>Original Dimensions:</strong> <span id="info-original-dims">-</span></p>
                    <p><strong>Current Dimensions:</strong> <span id="info-current-dims">-</span></p>
                    <div class="flex justify-between items-center info-line-flex">
                        <p class="mb-0"><strong>File Type:</strong> <span id="info-file-type">-</span></p>
                        <div class="credit-line">
                            <span>A project by <strong>Geetartha</strong>:</span>
                            <a href="https://www.instagram.com/geetartha.sarma/" target="_blank" rel="noopener noreferrer" aria-label="Geetartha Sarma on Instagram">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="2" y="2" width="20" height="20" rx="5" ry="5" stroke="var(--accent-color)" fill="none"></rect>
                                    <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z" stroke="var(--accent-color)" fill="none"></path>
                                    <line x1="17.5" y1="6.5" x2="17.51" y2="6.5" stroke="var(--accent-color)"></line>
                                </svg>
                            </a>
                            <a href="https://x.com/geetartha373" target="_blank" rel="noopener noreferrer" aria-label="Geetartha Sarma on X">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                  <path d="M12.6.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H.316l5.733-6.57L0 .75h5.063l3.495 4.633L12.602.75Zm-.86 13.028h1.36L4.323 2.145H2.865l8.875 11.633Z"/>
                                </svg>
                            </a>
                            <a href="https://github.com/vladanila/vladanila.github.io" target="_blank" rel="noopener noreferrer" aria-label="Geetartha Sarma on GitHub">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
                 <div class="mt-4 text-center md:text-right">
                    <button id="reset-all-btn" class="btn hidden">Reset All Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <p id="modal-message">This is a message!</p>
            <button id="modal-close-btn" class="btn btn-primary">OK</button>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Theme Toggle ---
            const themeToggle = document.getElementById('theme-toggle');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const htmlElement = document.documentElement;
            const applyTheme = (theme) => {
                if (theme === 'dark') { htmlElement.classList.add('dark'); sunIcon.style.display = 'none'; moonIcon.style.display = 'block'; } 
                else { htmlElement.classList.remove('dark'); sunIcon.style.display = 'block'; moonIcon.style.display = 'none'; }
            };
            const savedTheme = localStorage.getItem('theme');
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
            if (savedTheme) applyTheme(savedTheme); else applyTheme(prefersDarkScheme.matches ? 'dark' : 'light');
            themeToggle.addEventListener('click', () => { const newTheme = htmlElement.classList.contains('dark') ? 'light' : 'dark'; applyTheme(newTheme); localStorage.setItem('theme', newTheme); });
            prefersDarkScheme.addEventListener('change', (e) => { if (!localStorage.getItem('theme')) applyTheme(e.matches ? 'dark' : 'light'); });

            // --- Modal ---
            const modal = document.getElementById('modal');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            function showModal(message) { modalMessage.textContent = message; modal.classList.add('active'); }
            modalCloseBtn.addEventListener('click', () => modal.classList.remove('active'));
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });

            // --- Globals ---
            const fileUpload = document.getElementById('file-upload');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imageCanvas = document.getElementById('image-canvas');
            const imagePlaceholder = document.getElementById('image-placeholder');
            const toolsContainer = document.getElementById('tools-container');
            const ctx = imageCanvas.getContext('2d');
            let cropper = null, originalImage = null, currentImageStateForCanvas = null;
            
            let originalFileName = '';
            let originalFileType = '';
            let originalCanvasWidth = 0; 
            let originalCanvasHeight = 0;
            let currentAspectRatio = NaN; // For crop presets

            let currentFilters = { brightness: 100, contrast: 100, grayscale: 0, sepia: 0, invert: 0 };

            // --- UI Elements ---
            const cropBtn = document.getElementById('crop-btn');
            const cropActionsDiv = document.getElementById('crop-actions');
            const confirmCropBtn = document.getElementById('confirm-crop-btn');
            const cancelCropBtn = document.getElementById('cancel-crop-btn');
            const cropInstructions = document.getElementById('crop-instructions');
            const cropPresetButtons = document.querySelectorAll('.crop-preset-group .btn-preset');

            const rotateLeftBtn = document.getElementById('rotate-left-btn');
            const rotateRightBtn = document.getElementById('rotate-right-btn');
            const flipHorizontalBtn = document.getElementById('flip-horizontal-btn');
            const flipVerticalBtn = document.getElementById('flip-vertical-btn');
            const brightnessSlider = document.getElementById('brightness-slider');
            const contrastSlider = document.getElementById('contrast-slider');
            const brightnessValueDisplay = document.getElementById('brightness-value');
            const contrastValueDisplay = document.getElementById('contrast-value');
            const resizeWidthInput = document.getElementById('resize-width');
            const resizeHeightInput = document.getElementById('resize-height');
            const aspectRatioLock = document.getElementById('aspect-ratio-lock');
            const resizeBtn = document.getElementById('resize-btn');
            const fileFormatSelect = document.getElementById('file-format');
            const jpegQualitySection = document.getElementById('jpeg-quality-section');
            const jpegQualitySlider = document.getElementById('jpeg-quality');
            const jpegQualityValueDisplay = document.getElementById('jpeg-quality-value');
            const downloadBtn = document.getElementById('download-btn');
            const resetAllBtn = document.getElementById('reset-all-btn');
            
            const toolSectionElements = [ 
                document.getElementById('transform-tool-section'),
                document.getElementById('filters-tool-section'),
                document.getElementById('resize-tool-section'),
                document.getElementById('download-tool-section')
            ];
            const imageInfoDisplayDiv = document.getElementById('image-info-display');
            const infoFileName = document.getElementById('info-file-name');
            const infoOriginalDims = document.getElementById('info-original-dims');
            const infoCurrentDims = document.getElementById('info-current-dims');
            const infoFileType = document.getElementById('info-file-type');

            // --- Image Info Display Logic ---
            function updateImageInfoDisplay() {
                if (!originalImage) { 
                    imageInfoDisplayDiv.classList.add('hidden');
                    return;
                }
                infoFileName.textContent = originalFileName || '-';
                infoOriginalDims.textContent = (originalCanvasWidth && originalCanvasHeight) ? `${originalCanvasWidth} x ${originalCanvasHeight} px` : '-';
                infoCurrentDims.textContent = (imageCanvas.width && imageCanvas.height) ? `${imageCanvas.width} x ${imageCanvas.height} px` : '-';
                infoFileType.textContent = originalFileType ? originalFileType.toUpperCase().replace('IMAGE/', '') : '-';
                imageInfoDisplayDiv.classList.remove('hidden');
            }


            // --- Main image drawing function (Commits state) ---
            function drawImageToCanvasAndCommit(sourceDataUrl, callback) {
                if (cropper) { cropper.destroy(); cropper = null; setCropUIVisible(false); }
                const img = new Image();
                img.onload = () => {
                    if (sourceDataUrl === originalImage && (!originalCanvasWidth || !originalCanvasHeight) ) { 
                        originalCanvasWidth = img.naturalWidth;
                        originalCanvasHeight = img.naturalHeight;
                    }
                    imageCanvas.width = img.naturalWidth;
                    imageCanvas.height = img.naturalHeight;
                    applyCombinedFiltersToContext(); 
                    ctx.drawImage(img, 0, 0, img.naturalWidth, img.naturalHeight);
                    currentImageStateForCanvas = imageCanvas.toDataURL(); 
                    
                    imagePlaceholder.style.display = 'none'; imageCanvas.style.display = 'block';
                    toolsContainer.classList.remove('hidden'); 
                    resetAllBtn.classList.remove('hidden');
                    
                    if (!cropper) {
                        document.querySelectorAll('#tools-container .tool-section button, #tools-container .tool-section input, #tools-container .tool-section select').forEach(el => el.disabled = false);
                    }

                    resizeWidthInput.value = imageCanvas.width;
                    resizeHeightInput.value = imageCanvas.height;
                    updateImageInfoDisplay(); 
                    if (callback) callback();
                };
                img.onerror = () => { showModal('Error loading image for canvas.'); resetEditorState(); };
                img.src = sourceDataUrl;
            }

            // --- Preview function for non-committing filter changes (e.g., sliders) ---
            function previewFiltersOnCanvas() {
                if (!currentImageStateForCanvas || cropper) return;
                const img = new Image();
                img.onload = () => {
                    if (imageCanvas.width !== img.naturalWidth || imageCanvas.height !== img.naturalHeight) {
                        imageCanvas.width = img.naturalWidth;
                        imageCanvas.height = img.naturalHeight;
                    }
                    ctx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
                    applyCombinedFiltersToContext(); 
                    ctx.drawImage(img, 0, 0, imageCanvas.width, imageCanvas.height);
                };
                img.onerror = () => console.error("Error loading image for filter preview.");
                img.src = currentImageStateForCanvas; 
            }
            
            // --- File Upload & Drag/Drop ---
            function handleNewFile(file) {
                if (!file) return;
                if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
                    showModal('Invalid file type.'); fileUpload.value = ''; return;
                }
                originalFileName = file.name; 
                originalFileType = file.type; 

                const reader = new FileReader();
                reader.onload = (e) => {
                    originalImage = e.target.result; 
                    currentImageStateForCanvas = originalImage; 
                    originalCanvasWidth = 0; originalCanvasHeight = 0; 
                    resetAllFiltersAndDraw(currentImageStateForCanvas); 
                    // Reset crop aspect ratio to free on new image
                    currentAspectRatio = NaN;
                    updateActivePresetButton();
                };
                reader.readAsDataURL(file);
            }
            fileUpload.addEventListener('change', (e) => handleNewFile(e.target.files[0]));
            imagePreviewContainer.addEventListener('dragover', (e) => { e.preventDefault(); imagePreviewContainer.classList.add('dragover'); });
            imagePreviewContainer.addEventListener('dragleave', () => imagePreviewContainer.classList.remove('dragover'));
            imagePreviewContainer.addEventListener('drop', (e) => { e.preventDefault(); imagePreviewContainer.classList.remove('dragover'); handleNewFile(e.dataTransfer.files[0]); });
            
            // --- Editor Reset ---
            function resetEditorState() {
                if (cropper) { cropper.destroy(); cropper = null; }
                setCropUIVisible(false); 
                originalImage = null; currentImageStateForCanvas = null;
                originalCanvasWidth = 0; originalCanvasHeight = 0;
                originalFileName = ''; originalFileType = '';
                currentAspectRatio = NaN; // Reset aspect ratio
                ctx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
                imageCanvas.width = 0; imageCanvas.height = 0; 
                imageCanvas.style.display = 'none'; imagePlaceholder.style.display = 'block';
                toolsContainer.classList.add('hidden'); 
                resetAllBtn.classList.add('hidden');
                imageInfoDisplayDiv.classList.add('hidden'); 
                fileUpload.value = '';
                resetFilterControlsToDefaults();
                updateActivePresetButton();
                resizeWidthInput.value = ''; resizeHeightInput.value = '';
            }

            // --- Filter Logic ---
            function applyCombinedFiltersToContext() {
                ctx.filter = `brightness(${currentFilters.brightness}%) contrast(${currentFilters.contrast}%) grayscale(${currentFilters.grayscale}%) sepia(${currentFilters.sepia}%) invert(${currentFilters.invert}%)`;
            }
            brightnessSlider.addEventListener('input', (e) => { 
                if (cropper) return;
                currentFilters.brightness = e.target.value; 
                brightnessValueDisplay.textContent = e.target.value;
                previewFiltersOnCanvas(); 
            });
            contrastSlider.addEventListener('input', (e) => { 
                if (cropper) return;
                currentFilters.contrast = e.target.value; 
                contrastValueDisplay.textContent = e.target.value;
                previewFiltersOnCanvas(); 
            });
            ['grayscale', 'sepia', 'invert'].forEach(type => {
                document.getElementById(`filter-${type}`).addEventListener('click', () => {
                    if (cropper) return; 
                    currentFilters[type] = currentFilters[type] === 100 ? 0 : 100;
                    drawImageToCanvasAndCommit(currentImageStateForCanvas); 
                });
            });
            document.getElementById('filter-none').addEventListener('click', () => {
                if (cropper) return;
                resetFilterControlsToDefaults();
                drawImageToCanvasAndCommit(currentImageStateForCanvas); 
            });
            function resetFilterControlsToDefaults() {
                currentFilters = { brightness: 100, contrast: 100, grayscale: 0, sepia: 0, invert: 0 };
                brightnessSlider.value = 100; contrastSlider.value = 100;
                brightnessValueDisplay.textContent = 100; contrastValueDisplay.textContent = 100;
            }
            function resetAllFiltersAndDraw(sourceDataUrl, callback) { 
                resetFilterControlsToDefaults();
                if (sourceDataUrl) drawImageToCanvasAndCommit(sourceDataUrl, callback);
            }

            // --- Transform Logic (Commits changes) ---
            function rotateImage(degrees) {
                if (!currentImageStateForCanvas || cropper) return;
                const img = new Image();
                img.onload = () => {
                    const oldWidth = imageCanvas.width; const oldHeight = imageCanvas.height;
                    let newWidth = oldWidth; let newHeight = oldHeight;
                    if (degrees === 90 || degrees === -90) { newWidth = oldHeight; newHeight = oldWidth; }
                    imageCanvas.width = newWidth; imageCanvas.height = newHeight;
                    ctx.clearRect(0,0,newWidth, newHeight); 
                    ctx.translate(newWidth / 2, newHeight / 2); ctx.rotate(degrees * Math.PI / 180);
                    const tempImgForFilter = new Image(); 
                    tempImgForFilter.onload = () => {
                        applyCombinedFiltersToContext(); 
                        ctx.drawImage(tempImgForFilter, -oldWidth / 2, -oldHeight / 2, oldWidth, oldHeight);
                        ctx.setTransform(1, 0, 0, 1, 0, 0); 
                        currentImageStateForCanvas = imageCanvas.toDataURL(); 
                        resizeWidthInput.value = newWidth; resizeHeightInput.value = newHeight;
                        updateImageInfoDisplay(); 
                    }
                    tempImgForFilter.src = currentImageStateForCanvas; 
                };
                img.src = currentImageStateForCanvas; 
            }
            function flipImage(direction) { 
                if (!currentImageStateForCanvas || cropper) return;
                const img = new Image();
                img.onload = () => {
                    const imgWidth = imageCanvas.width; const imgHeight = imageCanvas.height;
                    ctx.clearRect(0,0,imgWidth, imgHeight);
                    if (direction === 'horizontal') { ctx.translate(imgWidth, 0); ctx.scale(-1, 1); } 
                    else if (direction === 'vertical') { ctx.translate(0, imgHeight); ctx.scale(1, -1); }
                    const tempImgForFilter = new Image();
                    tempImgForFilter.onload = () => {
                        applyCombinedFiltersToContext();
                        ctx.drawImage(tempImgForFilter, 0, 0, imgWidth, imgHeight);
                        ctx.setTransform(1, 0, 0, 1, 0, 0); 
                        currentImageStateForCanvas = imageCanvas.toDataURL(); 
                        updateImageInfoDisplay(); 
                    }
                    tempImgForFilter.src = currentImageStateForCanvas;
                };
                img.src = currentImageStateForCanvas;
            }
            rotateLeftBtn.addEventListener('click', () => rotateImage(-90));
            rotateRightBtn.addEventListener('click', () => rotateImage(90));
            flipHorizontalBtn.addEventListener('click', () => flipImage('horizontal'));
            flipVerticalBtn.addEventListener('click', () => flipImage('vertical'));

            // --- Resize Logic (Commits changes) ---
            function updateResizeInputsBasedOnAspectRatio(changedInput) { 
                if (!aspectRatioLock.checked || !imageCanvas.width || !imageCanvas.height) return;
                const currentCanvasWidth = imageCanvas.width; const currentCanvasHeight = imageCanvas.height;
                const aspectRatio = (currentCanvasWidth > 0) ? currentCanvasHeight / currentCanvasWidth : 0;
                if (changedInput === 'width') {
                    const newWidth = parseInt(resizeWidthInput.value);
                    if (!isNaN(newWidth) && newWidth > 0 && aspectRatio > 0) resizeHeightInput.value = Math.round(newWidth * aspectRatio);
                     else if (newWidth <=0 && aspectRatio > 0) resizeHeightInput.value = ''; 
                } else if (changedInput === 'height') {
                    const newHeight = parseInt(resizeHeightInput.value);
                    const invAspectRatio = (currentCanvasHeight > 0) ? currentCanvasWidth / currentCanvasHeight : 0;
                    if (!isNaN(newHeight) && newHeight > 0 && invAspectRatio > 0) resizeWidthInput.value = Math.round(newHeight * invAspectRatio);
                    else if (newHeight <= 0 && invAspectRatio > 0) resizeWidthInput.value = ''; 
                }
            }
            resizeWidthInput.addEventListener('input', () => updateResizeInputsBasedOnAspectRatio('width'));
            resizeHeightInput.addEventListener('input', () => updateResizeInputsBasedOnAspectRatio('height'));
            resizeBtn.addEventListener('click', () => {
                if (!currentImageStateForCanvas || cropper) { showModal('Upload an image and ensure no crop is active.'); return; }
                const width = parseInt(resizeWidthInput.value); const height = parseInt(resizeHeightInput.value);
                if (isNaN(width) || isNaN(height) || width <= 0 || height <= 0) { showModal('Valid positive dimensions required.'); return; }
                const tempImg = new Image();
                tempImg.onload = () => { 
                    imageCanvas.width = width; imageCanvas.height = height;
                    applyCombinedFiltersToContext(); 
                    ctx.drawImage(tempImg, 0, 0, width, height); 
                    currentImageStateForCanvas = imageCanvas.toDataURL(); 
                    updateImageInfoDisplay(); 
                };
                tempImg.src = currentImageStateForCanvas; 
            });

            // --- Crop Logic ---
            function updateActivePresetButton() {
                cropPresetButtons.forEach(button => {
                    const ratio = parseFloat(button.dataset.ratio);
                    if ( (isNaN(currentAspectRatio) && isNaN(ratio)) || (currentAspectRatio === ratio) ) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });
            }

            cropPresetButtons.forEach(button => {
                button.addEventListener('click', () => {
                    currentAspectRatio = parseFloat(button.dataset.ratio);
                    updateActivePresetButton();
                    if (cropper) {
                        cropper.setAspectRatio(currentAspectRatio);
                    }
                });
            });
            
            function setCropUIVisible(visible) {
                cropBtn.classList.toggle('hidden', visible);
                cropActionsDiv.classList.toggle('hidden', !visible);
                cropInstructions.style.display = visible ? 'block' : 'none';
                cropBtn.disabled = visible;

                toolSectionElements.forEach(section => {
                    if (section) { 
                        section.style.opacity = visible ? '0.5' : '1';
                        section.style.pointerEvents = visible ? 'none' : 'auto';
                        section.querySelectorAll('button, input, select').forEach(control => {
                            control.disabled = visible;
                        });
                    }
                });
                cropPresetButtons.forEach(btn => btn.disabled = visible);
            }
            cropBtn.addEventListener('click', () => {
                if (!currentImageStateForCanvas) { showModal('Please upload an image first.'); return; }
                if (cropper) { cropper.destroy(); cropper = null; setCropUIVisible(false); return; }
                
                const imgForCrop = new Image();
                imgForCrop.onload = () => {
                    const tempCanvasForCrop = document.createElement('canvas');
                    const tempCtxForCrop = tempCanvasForCrop.getContext('2d');
                    tempCanvasForCrop.width = imgForCrop.naturalWidth;
                    tempCanvasForCrop.height = imgForCrop.naturalHeight;
                    tempCtxForCrop.filter = `brightness(${currentFilters.brightness}%) contrast(${currentFilters.contrast}%) grayscale(${currentFilters.grayscale}%) sepia(${currentFilters.sepia}%) invert(${currentFilters.invert}%)`;
                    tempCtxForCrop.drawImage(imgForCrop, 0, 0);
                    const stateWithLiveFilters = tempCanvasForCrop.toDataURL();

                    drawImageToCanvasAndCommit(stateWithLiveFilters, () => {
                        cropper = new Cropper(imageCanvas, { 
                            aspectRatio: currentAspectRatio, 
                            viewMode: 1, background: true, autoCropArea: 0.8, responsive: true,
                            modal: true, guides: true, center: true, highlight: true,
                            cropBoxMovable: true, cropBoxResizable: true,
                        });
                        setCropUIVisible(true);
                    });
                };
                imgForCrop.src = currentImageStateForCanvas; 
            });
            confirmCropBtn.addEventListener('click', () => {
                if (!cropper) return;
                const croppedCanvas = cropper.getCroppedCanvas();
                const croppedDataUrl = croppedCanvas.toDataURL(fileFormatSelect.value === 'image/jpeg' ? 'image/jpeg' : 'image/png');
                cropper.destroy(); cropper = null;
                setCropUIVisible(false);
                currentImageStateForCanvas = croppedDataUrl; 
                resetAllFiltersAndDraw(currentImageStateForCanvas); 
                showModal('Image cropped.');
            });
            cancelCropBtn.addEventListener('click', () => {
                if (!cropper) return;
                cropper.destroy(); cropper = null;
                setCropUIVisible(false);
                drawImageToCanvasAndCommit(currentImageStateForCanvas); 
            });

            // --- Format & Download ---
            fileFormatSelect.addEventListener('change', () => {
                jpegQualitySection.classList.toggle('hidden', fileFormatSelect.value !== 'image/jpeg');
            });
            jpegQualitySlider.addEventListener('input', (e) => { jpegQualityValueDisplay.textContent = parseFloat(e.target.value).toFixed(2); });
            downloadBtn.addEventListener('click', () => {
                if (!currentImageStateForCanvas) { showModal('No image to download.'); return; }
                if (cropper) { showModal('Confirm or cancel crop first.'); return;}
                
                const imgToDownload = new Image();
                imgToDownload.onload = () => {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCanvas.width = imgToDownload.naturalWidth;
                    tempCanvas.height = imgToDownload.naturalHeight;
                    tempCtx.filter = `brightness(${currentFilters.brightness}%) contrast(${currentFilters.contrast}%) grayscale(${currentFilters.grayscale}%) sepia(${currentFilters.sepia}%) invert(${currentFilters.invert}%)`;
                    tempCtx.drawImage(imgToDownload, 0, 0);

                    const format = fileFormatSelect.value;
                    const quality = (format === 'image/jpeg') ? parseFloat(jpegQualitySlider.value) : undefined;
                    const dataURL = tempCanvas.toDataURL(format, quality); 
                    const link = document.createElement('a');
                    const extension = format.split('/')[1];
                    link.download = `Imagist_edited.${extension}`;
                    link.href = dataURL;
                    document.body.appendChild(link); link.click(); document.body.removeChild(link);
                    showModal(`Image downloaded as Imagist_edited.${extension}`);
                };
                imgToDownload.src = currentImageStateForCanvas; 
            });

            // --- Reset All ---
            resetAllBtn.addEventListener('click', () => {
                if (originalImage) {
                    currentImageStateForCanvas = originalImage; 
                    originalCanvasWidth = 0; originalCanvasHeight = 0; 
                    originalFileName = ''; originalFileType = ''; 
                    currentAspectRatio = NaN; 
                    resetAllFiltersAndDraw(originalImage); 
                    updateActivePresetButton();
                    showModal('All changes reset.');
                } else {
                    resetEditorState(); 
                }
            });
            
            resetEditorState(); 
        });
    </script>
</body>
</html>
